services:
  app1:
    build: .
    container_name: app1
    environment:
      - DB_HOST=db
      - DB_REPLICA_HOST=db_replica
      - DB_USER=postgres
      - DB_PASS=postgres
      - DB_NAME=backend_project
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - APP_INSTANCE=1
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_started
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  app2:
    build: .
    container_name: app2
    environment:
      - DB_HOST=db
      - DB_REPLICA_HOST=db_replica
      - DB_USER=postgres
      - DB_PASS=postgres
      - DB_NAME=backend_project
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_started
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  db:
    image: postgres:15
    container_name: backend_db
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: backend_project
      POSTGRES_HOST_AUTH_METHOD: trust
    ports:
      - '5432:5432'
    volumes:
      - db_data:/var/lib/postgresql/data
      - ./init-replication.sh:/docker-entrypoint-initdb.d/init-replication.sh
      - ./pg_hba.conf:/etc/postgresql/pg_hba.conf
    command: |
      postgres 
      -c wal_level=replica 
      -c max_wal_senders=3 
      -c max_replication_slots=3 
      -c hot_standby=on
      -c hba_file=/etc/postgresql/pg_hba.conf
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  db_replica:
    image: postgres:15
    container_name: backend_db_replica
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      PGUSER: postgres
      PGPASSWORD: postgres
    ports:
      - '5433:5432'
    depends_on:
      db:
        condition: service_healthy
    command: |
      bash -c '
      until pg_basebackup --pgdata=/var/lib/postgresql/data -R --slot=replication_slot --host=db --port=5432 -U postgres
      do
        echo "Waiting for master to be ready..."
        sleep 2s
      done
      echo "Backup done, starting replica..."
      chown -R postgres:postgres /var/lib/postgresql/data
      chmod 0700 /var/lib/postgresql/data
      exec gosu postgres postgres -c hot_standby=on
      '
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7
    container_name: backend_redis
    ports:
      - '6379:6379'

  nginx:
    image: nginx:latest
    container_name: backend_nginx
    ports:
      - '8080:8080'
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - app1
      - app2

  prometheus:
    image: prom/prometheus:latest
    container_name: backend_prometheus
    ports:
      - '9090:9090'
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
    depends_on:
      - app1
      - app2

  grafana:
    image: grafana/grafana:latest
    container_name: backend_grafana
    ports:
      - '3001:3000'
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_SECURITY_ADMIN_USER=admin
    volumes:
      - grafana_data:/var/lib/grafana
    depends_on:
      - prometheus

volumes:
  db_data:
  db_replica_data:
  prometheus_data:
  grafana_data: